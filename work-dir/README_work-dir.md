# work-dir/

This directory is the **runtime data directory** for the Vision Refactor Project.

It holds all data that is generated at runtime: configs, datasets, trained models, run logs,
annotated outputs, statistics databases, and temporary files.

**None of the runtime artifacts in this directory are committed to Git.**  
Only the template files (`config.example.toml`, `README.md`, `.gitkeep`) are tracked.

---

## Table of Contents

1. [Purpose and Design](#purpose-and-design)
2. [Directory Structure](#directory-structure)
3. [Initial Setup](#initial-setup)
4. [Configuration Files](#configuration-files)
5. [Sub-directory Details](#sub-directory-details)
   - [datasets/](#datasets)
   - [models/](#models)
   - [runs/](#runs)
   - [outputs/](#outputs)
   - [stats/](#stats)
   - [tmp/](#tmp)
6. [Config Path Resolution](#config-path-resolution)
7. [Gitignore Behaviour](#gitignore-behaviour)

---

## Purpose and Design

All pipeline modules write their runtime output under `work-dir/`.  The directory is
created automatically by the kernel on first run via `_ensure_workdir_layout()`.

The separation of code (`train/`, `share/`, etc.) and data (`work-dir/`) allows you to:
- Keep the repository clean and fast to clone/push.
- Store large datasets and model weights on separate volumes without changing code.
- Override the root path with `--workdir /mnt/data/vision-work` to redirect all output.

---

## Directory Structure

```
work-dir/
├── config.example.toml     ← Template: copy to config.toml before first run
├── config.toml             ← Your local config (gitignored, never committed)
├── config.resolved.toml    ← Auto-generated: resolved config from most recent run
├── log.txt                 ← Structured JSONL log (all pipeline events)
│
├── datasets/               ← Input data
│   ├── yolo/               ← YOLO-format dataset (images/ + labels/ + dataset.yaml)
│   ├── labeled/            ← Labeled images output by autolabel
│   └── unlabeled/          ← Raw images to be processed by autolabel
│
├── models/                 ← Trained model weights
│   └── <run-id>/
│       ├── model.onnx         ← Full-precision ONNX model
│       └── model-int8.onnx    ← INT-8 quantized ONNX model (deploy-ready)
│
├── runs/                   ← Per-run metadata
│   └── <run-id>/
│       ├── metrics.json       ← Run ID, status, elapsed time, errors
│       ├── artifacts.json     ← Backend-specific output paths and details
│       └── config.resolved.toml  ← Exact config used for this run
│
├── outputs/                ← Annotated frame images (from edge deploy with save_annotated=true)
├── stats/
│   └── stats.db            ← SQLite database for detection telemetry
└── tmp/                    ← Temporary files (safe to delete between runs)
```

---

## Initial Setup

```bash
# Step 1: Copy the template config
cp work-dir/config.example.toml work-dir/config.toml

# Step 2: Edit the config for your environment
#   - Set class_map.names and class_map.id_map
#   - Set data.yolo_dataset_dir (for training)
#   - Set train.yolo.weights (pretrained checkpoint path)
#   - Set train.device ("cpu", "cuda", or "mps")
#   - Adjust paths as needed

# Step 3: Run any pipeline module — work-dir subdirectories are created automatically
python -m train.cli --config ./work-dir/config.toml
```

The kernel automatically creates `datasets/`, `models/`, `runs/`, `outputs/`, `stats/`,
and `tmp/` on the first run of any pipeline.

---

## Configuration Files

### `config.example.toml` (committed to Git)

A fully annotated template covering all configuration sections and fields.
Copy this to `config.toml` before running anything.  Do not edit this file for
your local settings — it is shared with all contributors.

### `config.toml` (gitignored)

Your local configuration.  Contains machine-specific paths, model paths, API keys,
and environment-specific settings.  **Never commit this file.**

### `config.resolved.toml` (gitignored, auto-generated)

After each pipeline run, a copy of the final resolved configuration (all relative paths
expanded to absolute paths, all overrides applied) is written here.  This is a diagnostic
file — use it to reproduce a run exactly or to audit what settings were active.

---

## Sub-directory Details

### `datasets/`

Holds all input data for training and autolabeling.

```
datasets/
├── yolo/                ← Full YOLO-format dataset
│   ├── images/
│   │   ├── train/
│   │   └── val/
│   ├── labels/
│   │   ├── train/
│   │   └── val/
│   └── dataset.yaml
├── labeled/             ← Output of autolabel pipeline (images + label files)
└── unlabeled/           ← Input images for autolabel (no label files yet)
```

**Dataset path config:**

```toml
[data]
yolo_dataset_dir = "./work-dir/datasets/yolo"     # for train.backend = "yolo"
labeled_dir      = "./work-dir/datasets/labeled"   # autolabel writes here
unlabeled_dir    = "./work-dir/datasets/unlabeled" # autolabel reads from here
```

### `models/`

Trained model artifacts.  Each run that produces a model creates a subdirectory named
by run ID.

```
models/
└── exp001-20250101-120000/
    ├── model.onnx           ← Full-precision ONNX (opset 17 by default)
    └── model-int8.onnx      ← INT-8 dynamically quantized ONNX (for edge deploy)
```

The quantized model is suitable for deployment via `deploy.edge` and `autolabel.model`.

### `runs/`

Every pipeline invocation (train, autolabel, deploy edge/remote) writes its metadata here.

```
runs/
└── exp001-20250101-120000/
    ├── metrics.json
    ├── artifacts.json
    └── config.resolved.toml
```

**`metrics.json` structure:**

```json
{
  "run_id":     "exp001-20250101-120000",
  "mode":       "train",
  "status":     "ok",
  "elapsed_ms": 12345.678,
  "error":      null
}
```

**`artifacts.json` structure (train example):**

```json
{
  "run_id":   "exp001-20250101-120000",
  "mode":     "train",
  "backend":  "yolo",
  "status":   "ok",
  "error":    null,
  "artifacts": {
    "model_path":      "/abs/path/to/work-dir/models/exp001.../model.onnx",
    "model_int8_path": "/abs/path/to/work-dir/models/exp001.../model-int8.onnx",
    "epochs_trained":  50,
    "best_map50":      0.872
  }
}
```

### `outputs/`

Annotated frame images from edge deployment when `deploy.edge.save_annotated = true`.

Files are named `<frame-number>.jpg` or `<source-filename>_annotated.jpg` depending on
the source type.

### `stats/`

SQLite database written by the statistics service.

```
stats/
└── stats.db      ← SQLite database; ~1 KB overhead + ~200 bytes per event
```

The database is auto-created by `init_stats_db()` on first use.  It is safe to delete
`stats.db` to reset all telemetry history (the statistics service will recreate it on
next start).

**Schema:**

```sql
CREATE TABLE stats_events (
    id               INTEGER PRIMARY KEY AUTOINCREMENT,
    source_id        TEXT    NOT NULL,
    ts_utc           TEXT    NOT NULL,
    total_detections INTEGER NOT NULL,
    counts_by_class  TEXT    NOT NULL,   -- JSON string
    latency_ms       REAL    NOT NULL
);
```

### `tmp/`

Temporary working files.  Contents are safe to delete at any time.  Currently used for
intermediate files during ONNX export and frame buffering.

---

## Config Path Resolution

All path fields in `config.toml` are resolved at load time.  If a path is relative:

- When `config.toml` is inside `work-dir/`, paths are resolved from the **repository root**
  (one level up), preserving legacy behaviour.
- Otherwise, paths are resolved relative to the directory containing `config.toml`.

Absolute paths are always used as-is.

This means the standard `./work-dir/...` style paths in `config.example.toml` work
correctly when `config.toml` is at `work-dir/config.toml`, because they resolve from
the repo root.

---

## Gitignore Behaviour

The following patterns are excluded from Git (via the root `.gitignore`):

```gitignore
work-dir/config.toml
work-dir/config.resolved.toml
work-dir/log.txt
work-dir/datasets/
work-dir/models/
work-dir/runs/
work-dir/outputs/
work-dir/stats/
work-dir/tmp/
work-dir/*.pid
codex.md
```

The following are **kept** in Git:

```gitignore
!work-dir/config.example.toml
!work-dir/README.md
!work-dir/.gitkeep
```

